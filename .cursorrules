# Landing Page Next.js 15 + Sanity CMS - Cursor AI Rules

## ğŸ¯ Project Overview

Modern landing page system with Sanity CMS, webhook-based ISR, and production-ready deployment.

**Status:** âœ… PRODUCTION (Nov 23, 2024)  
**Build:** âœ… Passing | TypeScript: âœ… Strict | Linting: âœ… Clean  
**Tech Stack:** Next.js 15.5.4, React 19.2.0, Sanity 3.60.0, TypeScript 5.5.4

---

## ğŸ—ï¸ Architecture Decisions

### âœ… Single-CMS Architecture (Sanity Only)

**Decision Date:** November 2024  
**Status:** Production Verified

**Rationale:**
- Sanity = single source of truth (content creation + production delivery)
- Webhook + tag-based revalidation = instant updates (~5-10s)
- No dual-CMS sync complexity
- AI-native features (Canvas, AI Assist) built-in

**Key Configuration:**
```typescript
// lib/sanity.client.ts
export const client = createClient({
  useCdn: false,  // â† CRITICAL for ISR
  apiVersion: '2024-01-01',
  perspective: 'published'
});
```

### âœ… Tag-Based Revalidation (NOT Path-Based)

**Cache Tags Strategy:**
- `'landing-page'` â†’ Global (all pages)
- `'variant:{slug}'` â†’ Granular (specific page only)

**Why NOT revalidatePath():**
- Too broad - invalidates unnecessary pages
- Less granular control
- Tag-based = industry standard (Puma, AT&T use this)

**Implementation:**
```typescript
// app/[variant]/page.tsx
export const revalidate = false; // â† Disable time-based

const data = await sanityFetch(
  query,
  { slug },
  ['landing-page', `variant:${slug}`] // â† Cache tags
);
```

### âœ… Webhook Security (HMAC-SHA256)

**Flow:**
```
Sanity publish
  â†“
POST /api/revalidate
  â†“
HMAC validation (SHA256)
  â†“
revalidateTag()
  â†“
Fresh content (~5-10s)
```

**Implementation:**
```typescript
// app/api/revalidate/route.ts
const hmac = createHmac('sha256', secret);
hmac.update(body);
const expected = hmac.digest('hex');
if (signature !== expected) return 401;
```

---

## ğŸ“‹ Development Rules

### TypeScript Strict Mode

```typescript
// tsconfig.json
{
  "strict": true,
  "noUncheckedIndexedAccess": true,
  "forceConsistentCasingInFileNames": true
}
```

**All types must be defined:**
- No `any` (use `unknown` or proper types)
- Interface for all Sanity documents
- Export types from `lib/sanity.queries.ts`

### Next.js 15 Patterns

**Server Components (default):**
```typescript
// app/[variant]/page.tsx
export default async function Page({ params }: PageProps) {
  const { variant } = await params; // â† Next.js 15: params is Promise
  // ...
}
```

**Route Handlers:**
```typescript
// app/api/*/route.ts
export async function POST(req: Request) {
  // Use Request/Response, not NextRequest/NextResponse
}
```

**Metadata Generation:**
```typescript
export async function generateMetadata({ params }: PageProps) {
  const { variant } = await params;
  // Return metadata object
}
```

### Sanity Integration

**DO:**
- âœ… Use `sanityFetch()` wrapper (automatic cache tags)
- âœ… Define GROQ queries in `lib/sanity.queries.ts`
- âœ… Export TypeScript interfaces for all schemas
- âœ… Use `useCdn: false` (critical for ISR)

**DON'T:**
- âŒ Call `client.fetch()` directly (bypasses cache tags)
- âŒ Use `useCdn: true` (breaks revalidation)
- âŒ Forget to add cache tags
- âŒ Use `revalidatePath()` (use `revalidateTag()`)

### Git Workflow

**Branch Strategy:**
- `main` = Production (deployed to Vercel)
- `development` = Active development
- Feature branches â†’ PR to development

**Before Merge:**
```bash
# Create backup branches
git branch development-backup
git branch main-backup

# Merge with strategy
git checkout main
git merge development -X theirs
```

---

## ğŸ”§ Environment Variables

Required in `.env.local` and Vercel:

```env
# Sanity (required)
NEXT_PUBLIC_SANITY_PROJECT_ID=your_project_id
NEXT_PUBLIC_SANITY_DATASET=production
SANITY_WEBHOOK_SECRET=generate_with_openssl_rand_hex_32

# Optional
SANITY_API_TOKEN=sk_xxx  # For draft content preview
NEXT_PUBLIC_GTM_ID=GTM-XXX  # Analytics
```

---

## ğŸ“ File Structure

```
app/
â”œâ”€â”€ [variant]/
â”‚   â””â”€â”€ page.tsx              # Dynamic landing pages
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ revalidate/
â”‚   â”‚   â””â”€â”€ route.ts          # Webhook handler
â”‚   â””â”€â”€ lead/
â”‚       â””â”€â”€ route.ts          # Form submission
â””â”€â”€ layout.tsx

components/
â”œâ”€â”€ cms/                      # CMS-powered components
â”‚   â”œâ”€â”€ HeroCMS.tsx
â”‚   â”œâ”€â”€ Benefits.tsx
â”‚   â”œâ”€â”€ Methodology.tsx
â”‚   â”œâ”€â”€ Testimonials.tsx
â”‚   â””â”€â”€ FAQ.tsx
â””â”€â”€ ConsentBanner.tsx         # GDPR compliance

lib/
â”œâ”€â”€ sanity.client.ts          # Client config (useCdn: false!)
â”œâ”€â”€ sanity.fetch.ts           # Wrapper with cache tags
â”œâ”€â”€ sanity.queries.ts         # GROQ queries + types
â””â”€â”€ analytics.ts              # GTM integration

sanity/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ documents/
â”‚   â”‚   â””â”€â”€ landingPage.ts    # Main schema
â”‚   â””â”€â”€ modules/              # Content sections
â”‚       â”œâ”€â”€ hero.ts
â”‚       â”œâ”€â”€ benefits.ts
â”‚       â””â”€â”€ ...
â””â”€â”€ DEPLOYMENT_GUIDE.md       # Sanity setup docs
```

---

## ğŸš€ Deployment

### Vercel Configuration

**Environment Variables:**
- Add all from `.env.example`
- Production domain: Set in webhook URL

**Build Command:** `npm run build`  
**Output Directory:** `.next`  
**Install Command:** `npm install`

### Sanity Webhook Setup

**URL:** `https://your-domain.vercel.app/api/revalidate`  
**Filter:** `_type == "landingPage"`  
**Projection:** `{"_type": _type, "_id": _id, "slug": slug}`  
**Secret:** Same as `SANITY_WEBHOOK_SECRET`  
**Method:** POST

---

## ğŸ¨ Component Guidelines

### CMS Components

```typescript
// components/cms/Benefits.tsx
interface BenefitsProps {
  data?: {
    title?: string;
    items?: Array<{
      title: string;
      description?: string;
    }>;
  };
}

export default function Benefits({ data }: BenefitsProps) {
  if (!data?.items?.length) return null;
  // Render with null checks
}
```

**Pattern:**
- Accept optional `data` prop
- Return `null` if no data
- Use optional chaining (`?.`)
- TypeScript strict mode compliance

### Analytics Integration

```typescript
// Track events
import { trackEvent } from '@/lib/analytics';

trackEvent('cta_click', {
  location: 'hero',
  variant: 'A',
  text: 'Get Started'
});
```

---

## ğŸ§ª Testing

### Before Push

```bash
# Type check
npm run build

# Lint
npm run lint

# Dev test
npm run dev
```

### After Deploy

1. **Webhook Test:**
   - Edit in Sanity Studio
   - Click "Publish"
   - Wait 5-10s
   - Verify changes live

2. **Check Logs:**
   ```bash
   vercel logs --follow
   # Look for: [Webhook] Received validated payload
   ```

---

## ğŸ“Š Performance Requirements

- **LCP:** < 2.5s
- **FID:** < 100ms
- **CLS:** < 0.1
- **Revalidation:** < 10s

**Tools:**
- Vercel Analytics
- Lighthouse CI
- GTM for tracking

---

## ğŸ”® Roadmap (Phase 2)

### In Progress:
- [ ] MCP analytics integration (GA4/Meta/Vercel)
- [ ] Umami/Plausible (cookie-less fallback)
- [ ] A/B testing infrastructure refinement

### Planned:
- [ ] Form optimization
- [ ] SEO schema enhancement
- [ ] Performance dashboard

---

## ğŸ› Common Issues & Solutions

### Issue: Revalidation not working
**Solution:**
1. Check `useCdn: false` in sanity.client.ts
2. Verify webhook secret matches
3. Check Vercel logs for errors
4. Confirm cache tags in page.tsx

### Issue: TypeScript errors on `params`
**Solution:** Next.js 15 params are async:
```typescript
const { variant } = await params; // â† await!
```

### Issue: Build fails
**Solution:**
1. Check all env vars set
2. Run `npm run build` locally
3. Fix TypeScript errors
4. Ensure no `any` types

---

## ğŸ’¡ Best Practices

### DO:
âœ… Use Server Components (default)  
âœ… Add cache tags to all fetches  
âœ… Validate webhook signatures  
âœ… Type everything strictly  
âœ… Document architecture decisions  
âœ… Test revalidation after changes  

### DON'T:
âŒ Use `useCdn: true` (breaks ISR)  
âŒ Use `any` type  
âŒ Skip HMAC validation  
âŒ Use `revalidatePath()`  
âŒ Commit `.env.local`  
âŒ Force push to main  

---

## ğŸ“š Documentation

**Complete Guides:**
- `README.md` - Main setup & troubleshooting
- `IMPLEMENTATION_COMPLETE.md` - Full implementation summary
- `QUICK_START.md` - 5-minute setup
- `WEBHOOK_IMPLEMENTATION.md` - Technical webhook docs
- `sanity/DEPLOYMENT_GUIDE.md` - Sanity setup
- `sanity/schemas/SCHEMA_DOCUMENTATION.md` - Schema reference

**Status:** All docs updated Nov 23, 2024

---

**Last Updated:** November 23, 2024  
**Version:** 1.0.0 (Production)  
**Build Status:** âœ… Passing

